<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الدردشة - {{ room.name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .chat-container {
            height: calc(100vh - 56px);
            padding: 10px;
        }
        .messages-container {
            height: 400px;
            overflow-y: auto;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 10px;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 10px;
            max-width: 70%;
        }
        .my-message {
            background-color: #007bff;
            color: white;
            margin-left: auto;
            text-align: left;
        }
        .other-message {
            background-color: #e9ecef;
            color: #333;
            margin-right: auto;
        }
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            font-size: 0.8em;
        }
        .message-content {
            word-wrap: break-word;
        }
        .members-sidebar {
            background-color: white;
            border-radius: 10px;
            height: 100%;
        }
        @media (max-width: 768px) {
            .message {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/teacher/rooms">
                <i class="fas fa-arrow-right me-2"></i>
                العودة
            </a>
            <span class="navbar-text">
                <i class="fas fa-door-open me-1"></i>
                {{ room.name }}
            </span>
            <span class="navbar-text">
                أنت: {{ session.name }}
            </span>
        </div>
    </nav>

    <div class="container-fluid chat-container">
        <div class="row h-100">
            <!-- قائمة الطلاب -->
            <div class="col-md-3 d-none d-md-block members-sidebar">
                <div class="card h-100">
                    <div class="card-header bg-info text-white">
                        <i class="fas fa-users me-2"></i>
                        طلاب الغرفة ({{ students|length }})
                    </div>
                    <div class="card-body p-0">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>
                                    <i class="fas fa-chalkboard-teacher text-primary me-2"></i>
                                    {{ session.name }}
                                </span>
                                <span class="badge bg-primary">معلم</span>
                            </li>
                            {% for student in students %}
                            <li class="list-group-item">
                                <i class="fas fa-user-graduate text-success me-2"></i>
                                {{ student.name }}
                                <br>
                                <small class="text-muted">{{ student.grade }}/{{ student.section }}</small>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>

            <!-- منطقة الرسائل -->
            <div class="col-md-9 col-12">
                <div class="card h-100">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-comments me-2"></i>
                            دردشة {{ room.name }}
                        </h6>
                        <small class="text-muted">{{ room.subject }} - {{ room.grade }}/{{ room.section }}</small>
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshMessages()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    
                    <!-- الرسائل -->
                    <div class="card-body messages-container" id="messagesContainer">
                        {% for message in messages %}
                        <div class="message {% if message.user_id == session.user_id %}my-message{% else %}other-message{% endif %}">
                            <div class="message-header">
                                <strong>
                                    {% if message.user_type == 'teacher' %}
                                        <i class="fas fa-chalkboard-teacher text-primary me-1"></i>
                                    {% else %}
                                        <i class="fas fa-user-graduate text-success me-1"></i>
                                    {% endif %}
                                    {{ message.user_name }}
                                </strong>
                                <small class="text-muted">{{ message.sent_at[:16] }}</small>
                            </div>
                            <div class="message-content">
                                {{ message.message }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- إرسال الرسالة -->
                    <div class="card-footer">
                        <form id="messageForm" onsubmit="sendMessage(event)">
                            <div class="input-group">
                                <input type="text" class="form-control" id="messageInput" 
                                       placeholder="اكتب رسالتك هنا..." maxlength="500" required>
                                <button class="btn btn-primary" type="submit">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function sendMessage(event) {
            event.preventDefault();
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (message) {
                fetch('/api/send_message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `room_id={{ room.id }}&message=${encodeURIComponent(message)}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        messageInput.value = '';
                        refreshMessages();
                    } else {
                        alert('خطأ في إرسال الرسالة: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('خطأ في الاتصال: ' + error);
                });
            }
        }
        
        function refreshMessages() {
            fetch('/api/get_messages/{{ room.id }}')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const messagesContainer = document.getElementById('messagesContainer');
                        messagesContainer.innerHTML = '';
                        
                        data.messages.forEach(message => {
                            const messageDiv = document.createElement('div');
                            const isMyMessage = message.user_id === {{ session.user_id }};
                            messageDiv.className = `message ${isMyMessage ? 'my-message' : 'other-message'}`;
                            
                            messageDiv.innerHTML = `
                                <div class="message-header">
                                    <strong>
                                        ${message.user_type === 'teacher' ? 
                                            '<i class="fas fa-chalkboard-teacher text-primary me-1"></i>' : 
                                            '<i class="fas fa-user-graduate text-success me-1"></i>'
                                        }
                                        ${message.user_name}
                                    </strong>
                                    <small class="text-muted">${message.sent_at.substring(0, 16)}</small>
                                </div>
                                <div class="message-content">
                                    ${message.message}
                                </div>
                            `;
                            
                            messagesContainer.appendChild(messageDiv);
                        });
                        
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                });
        }
        
        // تحديث الرسائل كل 3 ثواني
        setInterval(refreshMessages, 3000);
        
        // التمرير لأسفل عند تحميل الصفحة
        window.onload = function() {
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        };
    </script>
</body>
</html>